openapi: 3.0.3
info:
  title: ConvoAI Booking API
  description: |
    Public booking API for ConvoAI Services. This API allows customers to book appointments
    directly through ChatGPT Custom GPT integration.
    
    ## RouterGPT: Location-Based Discovery (Phase 3)
    
    RouterGPT enables location-based business discovery and seamless delegation:
    
    1. **Discovery Phase**: Customer shares location → Search for nearby businesses
    2. **Delegation Phase**: Customer selects business → Hand off to booking agent
    3. **Booking Phase**: Continue conversation with shop's booking agent
    
    ### Discovery Flow
    ```
    User: "I need a haircut near me"
    → Extract location (GPS, ZIP, address)
    → POST /router/search-by-location (find nearby shops)
    → Present top results to user
    → User selects a business
    → POST /router/delegate (hand off to shop)
    → Continue with POST /s/{slug}/chat
    ```
    
    ## Legacy Single-Shop Booking Flow
    1. Get business info and available services
    2. Check availability for desired date/service
    3. Create a booking QUOTE (does NOT create booking)
    4. CONFIRM the quote to create the actual booking
    
    **IMPORTANT**: The quote→confirm flow is mandatory. Quotes expire in 10 minutes.
    
    ## Authentication
    All endpoints require an API key passed in the `X-API-Key` header.
  version: 2.0.0
  contact:
    name: ConvoAI Support
    email: support@convoai.com

servers:
  - url: https://your-backend-domain.com
    description: Production server
  - url: http://localhost:8000
    description: Development server

security:
  - ApiKeyAuth: []

paths:
  # ────────────────────────────────────────────────────────────────
  # Phase 3: RouterGPT Discovery & Delegation Endpoints
  # ────────────────────────────────────────────────────────────────
  
  /router/search-by-location:
    post:
      operationId: searchBusinessesByLocation
      summary: Find businesses near customer's GPS location
      description: |
        Search for businesses near a geographic location. Use this when the customer
        shares their location or provides coordinates.
        
        **When to use:**
        - Customer says "near me" and shares GPS location
        - Customer provides a specific address
        - Customer gives ZIP code or city (geocode first, then search)
        
        **Response includes:**
        - List of nearby businesses sorted by distance
        - Distance in miles from customer
        - Confidence score (closer = higher confidence)
        
        After getting results, present the top 3 to the customer and ask them to choose.
      tags:
        - RouterGPT Discovery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationSearchRequest'
            example:
              latitude: 33.4255
              longitude: -111.94
              radius_miles: 10
              category: "barbershop"
      responses:
        '200':
          description: List of nearby businesses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationSearchResponse'
              example:
                query: "Businesses within 10.0 miles in category 'barbershop'"
                latitude: 33.4255
                longitude: -111.94
                radius_miles: 10.0
                results:
                  - business_id: 2
                    slug: "bishops-tempe"
                    name: "Bishops Tempe"
                    category: "barbershop"
                    address: "123 Mill Ave, Tempe, AZ 85281"
                    timezone: "America/Phoenix"
                    primary_phone: "+1-480-555-1234"
                    distance_miles: 0.5
                    confidence: 0.95
                  - business_id: 5
                    slug: "classic-cuts-mesa"
                    name: "Classic Cuts Mesa"
                    category: "barbershop"
                    address: "456 Main St, Mesa, AZ 85201"
                    timezone: "America/Phoenix"
                    primary_phone: "+1-480-555-5678"
                    distance_miles: 3.2
                    confidence: 0.68
                total_count: 2
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /router/delegate:
    post:
      operationId: delegateToBusinessBookingAgent
      summary: Hand off conversation to shop's booking agent
      description: |
        Delegate to a specific shop's booking agent after the customer selects a business.
        This endpoint prepares the handoff with context from the discovery phase.
        
        **When to use:**
        - Customer has selected a business from search results
        - Ready to start the booking conversation
        
        **Response includes:**
        - Unique session_id for tracking (include in subsequent /s/{slug}/chat calls)
        - Initial greeting message to show the customer
        - Available services to help start the conversation
        
        **After calling this endpoint:**
        1. Display the initial_message to the customer
        2. Show available services as options
        3. Route all subsequent messages to POST /s/{slug}/chat
        4. Always include router_session_id in chat requests
      tags:
        - RouterGPT Discovery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DelegateRequest'
            example:
              shop_slug: "bishops-tempe"
              customer_context:
                intent: "haircut"
                location:
                  lat: 33.4255
                  lon: -111.94
      responses:
        '200':
          description: Delegation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DelegateResponse'
              example:
                success: true
                shop_slug: "bishops-tempe"
                shop_name: "Bishops Tempe"
                session_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                initial_message: "Welcome to Bishops Tempe! I understand you're looking for haircut. We offer Men's Haircut, Women's Haircut, Beard Trim and more. What would you like to book today?"
                available_services:
                  - id: 1
                    name: "Men's Haircut"
                    duration_minutes: 30
                    price_cents: 3500
                    price_display: "$35.00"
                  - id: 2
                    name: "Women's Haircut"
                    duration_minutes: 45
                    price_cents: 5500
                    price_display: "$55.00"
        '404':
          description: Shop not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Shop not found: invalid-slug"

  /s/{slug}/chat:
    post:
      operationId: chatWithBusinessBookingAgent
      summary: Continue booking conversation with specific shop
      description: |
        Send a message to a shop's AI booking agent. Use this endpoint for all
        booking-related conversations after delegation.
        
        **When to use:**
        - After calling /router/delegate
        - For each customer message in the booking flow
        
        **Include RouterGPT context:**
        - router_session_id: From /router/delegate response
        - customer_location: From discovery phase
        - router_intent: Customer's stated intent
        
        The AI will guide the customer through:
        1. Service selection
        2. Date and time selection
        3. Stylist preference (optional)
        4. Customer information
        5. Booking confirmation
      tags:
        - Shop Booking Agent
      parameters:
        - name: slug
          in: path
          required: true
          description: Shop URL slug (e.g., "bishops-tempe")
          schema:
            type: string
          example: "bishops-tempe"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            example:
              messages:
                - role: "user"
                  content: "I'd like to book a men's haircut for tomorrow afternoon"
              router_session_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
              router_intent: "haircut"
              customer_location:
                lat: 33.4255
                lon: -111.94
      responses:
        '200':
          description: AI response with optional action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              example:
                reply: "Great choice! For a Men's Haircut tomorrow afternoon, I have these times available: 1:00 PM, 2:30 PM, or 4:00 PM. Which works best for you?"
                action:
                  type: "show_slots"
                  params:
                    service_id: 1
                    date: "2026-01-23"
                data:
                  slots:
                    - time: "13:00"
                      time_display: "1:00 PM"
                      stylist_name: "Alex"
                    - time: "14:30"
                      time_display: "2:30 PM"
                      stylist_name: "Jamie"
                    - time: "16:00"
                      time_display: "4:00 PM"
                      stylist_name: "Alex"
                chips:
                  - "1:00 PM"
                  - "2:30 PM"
                  - "4:00 PM"
                shop_slug: "bishops-tempe"
                shop_name: "Bishops Tempe"
        '404':
          description: Shop not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Shop not found: invalid-slug. Check the URL and try again."

  # ────────────────────────────────────────────────────────────────
  # Legacy Single-Shop Endpoints
  # ────────────────────────────────────────────────────────────────

  /public/business:
    get:
      operationId: getBusinessInfo
      summary: Get business information
      description: |
        Returns business name, timezone, working hours, and open days.
        Use this to understand when the business is available for bookings.
      responses:
        '200':
          description: Business information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessInfo'
              example:
                business_name: "Bishops Tempe"
                timezone: "America/Phoenix"
                working_hours_start: "09:00"
                working_hours_end: "17:00"
                working_days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
                address: "Tempe, Arizona"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /public/services:
    get:
      operationId: listServices
      summary: List available services
      description: |
        Returns all services available for booking with their IDs, names, durations, and prices.
        Use the service `id` when checking availability or creating quotes.
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
              example:
                - id: 1
                  name: "Men's Haircut"
                  duration_minutes: 30
                  price_cents: 3500
                  price_display: "$35.00"
                - id: 2
                  name: "Women's Haircut"
                  duration_minutes: 45
                  price_cents: 5500
                  price_display: "$55.00"
                - id: 3
                  name: "Beard Trim"
                  duration_minutes: 15
                  price_cents: 2000
                  price_display: "$20.00"
                - id: 4
                  name: "Hair Color"
                  duration_minutes: 90
                  price_cents: 12000
                  price_display: "$120.00"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /public/stylists:
    get:
      operationId: listStylists
      summary: List available stylists
      description: |
        Returns all active stylists who can perform services.
        Use the stylist `id` when creating booking quotes.
      responses:
        '200':
          description: List of stylists
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Stylist'
              example:
                - id: 1
                  name: "Alex"
                  available: true
                - id: 2
                  name: "Jamie"
                  available: true
        '401':
          $ref: '#/components/responses/Unauthorized'

  /public/availability:
    get:
      operationId: checkAvailability
      summary: Check available time slots
      description: |
        Check available appointment slots for a specific service on a specific date.
        Optionally filter by stylist.
        
        Returns a list of available time slots with stylist information.
        Use the `start_time` (in HH:MM format) and `stylist_id` when creating a quote.
      parameters:
        - name: service_id
          in: query
          required: true
          description: The ID of the service to book
          schema:
            type: integer
          example: 1
        - name: date
          in: query
          required: true
          description: Date to check availability (YYYY-MM-DD format)
          schema:
            type: string
            format: date
          example: "2026-01-22"
        - name: stylist_id
          in: query
          required: false
          description: Optional stylist ID to filter availability
          schema:
            type: integer
          example: 1
      responses:
        '200':
          description: Available slots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailabilityResponse'
              example:
                date: "2026-01-22"
                service_name: "Men's Haircut"
                slots:
                  - stylist_id: 1
                    stylist_name: "Alex"
                    start_time: "2026-01-22T18:00:00+00:00"
                    end_time: "2026-01-22T18:30:00+00:00"
                    start_time_local: "11:00 AM"
                    date_local: "January 22, 2026"
                  - stylist_id: 2
                    stylist_name: "Jamie"
                    start_time: "2026-01-22T19:00:00+00:00"
                    end_time: "2026-01-22T19:30:00+00:00"
                    start_time_local: "12:00 PM"
                    date_local: "January 22, 2026"
                message: "Found 2 available slot(s) for Men's Haircut."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /public/booking/quote:
    post:
      operationId: createBookingQuote
      summary: Create a booking quote
      description: |
        Creates a booking QUOTE for review. This does NOT create an actual booking.
        
        **IMPORTANT**: 
        - The quote must be confirmed using `/public/booking/confirm` to create the actual booking
        - Quotes expire in 10 minutes
        - Either `customer_email` OR `customer_phone` is required
        
        Returns a `quote_token` that must be used to confirm the booking.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuoteRequest'
            example:
              service_id: 1
              stylist_id: 1
              date: "2026-01-22"
              start_time: "11:00"
              customer_name: "John Smith"
              customer_email: "john@example.com"
              customer_phone: "+1-555-123-4567"
      responses:
        '200':
          description: Quote created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuoteResponse'
              example:
                quote_token: "abc123xyz789..."
                expires_at: "2026-01-20T20:10:00+00:00"
                service_name: "Men's Haircut"
                stylist_name: "Alex"
                date_local: "Wednesday, January 22, 2026"
                start_time_local: "11:00 AM"
                end_time_local: "11:30 AM"
                duration_minutes: 30
                price_cents: 3500
                price_display: "$35.00"
                customer_name: "John Smith"
                customer_contact: "jo***@example.com"
                message: "Quote created for Men's Haircut with Alex on Wednesday, January 22, 2026 at 11:00 AM. Please confirm within 10 minutes to complete your booking."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

  /public/booking/confirm:
    post:
      operationId: confirmBooking
      summary: Confirm a booking quote
      description: |
        Confirms a booking quote and creates the actual booking.
        
        **IMPORTANT**:
        - Requires the `quote_token` from the quote response
        - This is idempotent - calling multiple times after success returns the same booking
        - If the slot was taken between quote and confirm, returns 409 Conflict
        
        On success, returns the booking ID and confirmation details.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmRequest'
            example:
              quote_token: "abc123xyz789..."
      responses:
        '200':
          description: Booking confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmResponse'
              example:
                booking_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                status: "CONFIRMED"
                service_name: "Men's Haircut"
                stylist_name: "Alex"
                date_local: "Wednesday, January 22, 2026"
                start_time_local: "11:00 AM"
                end_time_local: "11:30 AM"
                customer_name: "John Smith"
                message: "Your booking is confirmed! Men's Haircut with Alex on Wednesday, January 22, 2026 at 11:00 AM. Booking ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Quote not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Quote not found or expired. Please create a new quote."
        '409':
          description: Slot no longer available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Sorry, this slot was just taken by another customer. Please choose a different time."

  /public/booking/{booking_id}:
    get:
      operationId: getBookingDetails
      summary: Get booking details
      description: |
        Retrieve details of an existing booking by its ID.
        Use this to verify booking status or show confirmation details.
      parameters:
        - name: booking_id
          in: path
          required: true
          description: The booking UUID
          schema:
            type: string
            format: uuid
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        '200':
          description: Booking details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookingDetails'
              example:
                booking_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                status: "CONFIRMED"
                service_name: "Men's Haircut"
                stylist_name: "Alex"
                date_local: "Wednesday, January 22, 2026"
                start_time_local: "11:00 AM"
                end_time_local: "11:30 AM"
                customer_name: "John Smith"
                price_display: "$35.00"
                created_at: "2026-01-20T20:00:00+00:00"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    BusinessInfo:
      type: object
      required:
        - business_name
        - timezone
        - working_hours_start
        - working_hours_end
        - working_days
      properties:
        business_name:
          type: string
          description: Name of the business
        timezone:
          type: string
          description: Business timezone (IANA format)
        working_hours_start:
          type: string
          description: Opening time (HH:MM)
        working_hours_end:
          type: string
          description: Closing time (HH:MM)
        working_days:
          type: array
          items:
            type: string
          description: Days the business is open
        address:
          type: string
          nullable: true
          description: Business address
        phone:
          type: string
          nullable: true
          description: Business phone number

    Service:
      type: object
      required:
        - id
        - name
        - duration_minutes
        - price_cents
        - price_display
      properties:
        id:
          type: integer
          description: Unique service ID
        name:
          type: string
          description: Service name
        duration_minutes:
          type: integer
          description: Duration in minutes
        price_cents:
          type: integer
          description: Price in cents
        price_display:
          type: string
          description: Formatted price display

    Stylist:
      type: object
      required:
        - id
        - name
        - available
      properties:
        id:
          type: integer
          description: Unique stylist ID
        name:
          type: string
          description: Stylist name
        available:
          type: boolean
          description: Whether stylist is currently available

    AvailabilitySlot:
      type: object
      required:
        - stylist_id
        - stylist_name
        - start_time
        - end_time
        - start_time_local
        - date_local
      properties:
        stylist_id:
          type: integer
          description: Stylist ID for this slot
        stylist_name:
          type: string
          description: Stylist name
        start_time:
          type: string
          format: date-time
          description: Start time in ISO format (UTC)
        end_time:
          type: string
          format: date-time
          description: End time in ISO format (UTC)
        start_time_local:
          type: string
          description: Start time in local format (e.g., "2:00 PM")
        date_local:
          type: string
          description: Date in local format (e.g., "January 22, 2026")

    AvailabilityResponse:
      type: object
      required:
        - date
        - service_name
        - slots
        - message
      properties:
        date:
          type: string
          description: Requested date
        service_name:
          type: string
          description: Service name
        slots:
          type: array
          items:
            $ref: '#/components/schemas/AvailabilitySlot'
          description: Available time slots
        message:
          type: string
          description: Human-readable summary

    QuoteRequest:
      type: object
      required:
        - service_id
        - stylist_id
        - date
        - start_time
        - customer_name
      properties:
        service_id:
          type: integer
          description: Service ID to book
        stylist_id:
          type: integer
          description: Stylist ID to book with
        date:
          type: string
          format: date
          description: Date in YYYY-MM-DD format
        start_time:
          type: string
          description: Start time in HH:MM format (24-hour)
        customer_name:
          type: string
          minLength: 1
          maxLength: 100
          description: Customer's name
        customer_email:
          type: string
          format: email
          nullable: true
          description: Customer's email (required if no phone)
        customer_phone:
          type: string
          nullable: true
          description: Customer's phone number (required if no email)

    QuoteResponse:
      type: object
      required:
        - quote_token
        - expires_at
        - service_name
        - stylist_name
        - date_local
        - start_time_local
        - end_time_local
        - duration_minutes
        - price_cents
        - price_display
        - customer_name
        - customer_contact
        - message
      properties:
        quote_token:
          type: string
          description: Token to confirm this quote
        expires_at:
          type: string
          format: date-time
          description: When this quote expires
        service_name:
          type: string
          description: Service name
        stylist_name:
          type: string
          description: Stylist name
        date_local:
          type: string
          description: Date in local format
        start_time_local:
          type: string
          description: Start time in local format
        end_time_local:
          type: string
          description: End time in local format
        duration_minutes:
          type: integer
          description: Duration in minutes
        price_cents:
          type: integer
          description: Price in cents
        price_display:
          type: string
          description: Formatted price
        customer_name:
          type: string
          description: Customer name
        customer_contact:
          type: string
          description: Masked contact info
        message:
          type: string
          description: Confirmation message

    ConfirmRequest:
      type: object
      required:
        - quote_token
      properties:
        quote_token:
          type: string
          description: Quote token from quote response

    ConfirmResponse:
      type: object
      required:
        - booking_id
        - status
        - service_name
        - stylist_name
        - date_local
        - start_time_local
        - end_time_local
        - customer_name
        - message
      properties:
        booking_id:
          type: string
          format: uuid
          description: Unique booking ID
        status:
          type: string
          description: Booking status (CONFIRMED)
        service_name:
          type: string
          description: Service name
        stylist_name:
          type: string
          description: Stylist name
        date_local:
          type: string
          description: Date in local format
        start_time_local:
          type: string
          description: Start time in local format
        end_time_local:
          type: string
          description: End time in local format
        customer_name:
          type: string
          description: Customer name
        message:
          type: string
          description: Confirmation message with booking ID

    BookingDetails:
      type: object
      required:
        - booking_id
        - status
        - service_name
        - stylist_name
        - date_local
        - start_time_local
        - end_time_local
        - customer_name
        - price_display
        - created_at
      properties:
        booking_id:
          type: string
          format: uuid
          description: Unique booking ID
        status:
          type: string
          description: Booking status
        service_name:
          type: string
          description: Service name
        stylist_name:
          type: string
          description: Stylist name
        date_local:
          type: string
          description: Date in local format
        start_time_local:
          type: string
          description: Start time in local format
        end_time_local:
          type: string
          description: End time in local format
        customer_name:
          type: string
          description: Customer name
        price_display:
          type: string
          description: Formatted price
        created_at:
          type: string
          format: date-time
          description: When booking was created

    # ────────────────────────────────────────────────────────────────
    # Phase 3: RouterGPT Schemas
    # ────────────────────────────────────────────────────────────────

    LocationSearchRequest:
      type: object
      required:
        - latitude
        - longitude
      properties:
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
          description: Customer's latitude coordinate (WGS84)
          example: 33.4255
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
          description: Customer's longitude coordinate (WGS84)
          example: -111.94
        radius_miles:
          type: number
          format: double
          minimum: 0.1
          maximum: 50
          default: 10
          description: Search radius in miles (default 10, max 50)
          example: 10
        category:
          type: string
          nullable: true
          description: Filter by business category (e.g., "barbershop", "salon")
          example: "barbershop"
        query:
          type: string
          nullable: true
          description: Optional text query to filter results
          example: "bishops"

    LocationSearchResult:
      type: object
      required:
        - business_id
        - slug
        - name
        - distance_miles
        - confidence
      properties:
        business_id:
          type: integer
          description: Unique business ID
          example: 2
        slug:
          type: string
          description: URL-safe slug for routing to shop endpoints
          example: "bishops-tempe"
        name:
          type: string
          description: Business display name
          example: "Bishops Tempe"
        category:
          type: string
          nullable: true
          description: Business category
          example: "barbershop"
        address:
          type: string
          nullable: true
          description: Business address
          example: "123 Mill Ave, Tempe, AZ 85281"
        timezone:
          type: string
          description: Business timezone (IANA format)
          example: "America/Phoenix"
        primary_phone:
          type: string
          nullable: true
          description: Business phone number
          example: "+1-480-555-1234"
        distance_miles:
          type: number
          format: double
          description: Distance from customer location in miles
          example: 0.5
        confidence:
          type: number
          format: double
          minimum: 0
          maximum: 1
          description: Confidence score (0-1, higher = closer/better match)
          example: 0.95

    LocationSearchResponse:
      type: object
      required:
        - query
        - latitude
        - longitude
        - radius_miles
        - results
        - total_count
      properties:
        query:
          type: string
          description: Human-readable query description
          example: "Businesses within 10.0 miles in category 'barbershop'"
        latitude:
          type: number
          format: double
          description: Search center latitude
        longitude:
          type: number
          format: double
          description: Search center longitude
        radius_miles:
          type: number
          format: double
          description: Search radius used
        results:
          type: array
          items:
            $ref: '#/components/schemas/LocationSearchResult'
          description: List of matching businesses sorted by distance
        total_count:
          type: integer
          description: Total number of results
          example: 2

    CustomerContext:
      type: object
      description: Context collected during discovery phase
      properties:
        intent:
          type: string
          nullable: true
          description: Customer's stated intent (e.g., "haircut", "color")
          example: "haircut"
        location:
          type: object
          nullable: true
          properties:
            lat:
              type: number
              format: double
              description: Customer latitude
            lon:
              type: number
              format: double
              description: Customer longitude

    DelegateRequest:
      type: object
      required:
        - shop_slug
      properties:
        shop_slug:
          type: string
          description: Shop slug from search results
          example: "bishops-tempe"
        customer_context:
          $ref: '#/components/schemas/CustomerContext'

    ServiceInfo:
      type: object
      required:
        - id
        - name
        - duration_minutes
        - price_cents
        - price_display
      properties:
        id:
          type: integer
          description: Service ID
          example: 1
        name:
          type: string
          description: Service name
          example: "Men's Haircut"
        duration_minutes:
          type: integer
          description: Duration in minutes
          example: 30
        price_cents:
          type: integer
          description: Price in cents
          example: 3500
        price_display:
          type: string
          description: Formatted price string
          example: "$35.00"

    DelegateResponse:
      type: object
      required:
        - success
        - shop_slug
        - shop_name
        - session_id
        - initial_message
        - available_services
      properties:
        success:
          type: boolean
          description: Whether delegation was successful
          example: true
        shop_slug:
          type: string
          description: Shop slug for subsequent requests
          example: "bishops-tempe"
        shop_name:
          type: string
          description: Shop display name
          example: "Bishops Tempe"
        session_id:
          type: string
          format: uuid
          description: Unique session ID for tracking (include in /s/{slug}/chat requests)
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        initial_message:
          type: string
          description: Welcome message to show the customer
          example: "Welcome to Bishops Tempe! I understand you're looking for haircut. We offer Men's Haircut, Women's Haircut, Beard Trim and more. What would you like to book today?"
        available_services:
          type: array
          items:
            $ref: '#/components/schemas/ServiceInfo'
          description: First 5 available services to show customer

    ChatMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: ["user", "assistant", "system"]
          description: Message role
          example: "user"
        content:
          type: string
          description: Message content
          example: "I'd like to book a men's haircut for tomorrow afternoon"

    CustomerLocation:
      type: object
      properties:
        lat:
          type: number
          format: double
          description: Customer latitude
          example: 33.4255
        lon:
          type: number
          format: double
          description: Customer longitude
          example: -111.94

    ChatRequest:
      type: object
      required:
        - messages
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessage'
          description: Conversation history
          minItems: 1
        context:
          type: object
          nullable: true
          description: Optional booking context (service_id, date, etc.)
        router_session_id:
          type: string
          format: uuid
          nullable: true
          description: Session ID from /router/delegate (for tracking)
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        router_intent:
          type: string
          nullable: true
          description: Customer's stated intent from discovery
          example: "haircut"
        customer_location:
          $ref: '#/components/schemas/CustomerLocation'

    ChatResponse:
      type: object
      required:
        - reply
      properties:
        reply:
          type: string
          description: AI assistant's response
          example: "Great choice! For a Men's Haircut tomorrow afternoon, I have these times available: 1:00 PM, 2:30 PM, or 4:00 PM. Which works best for you?"
        action:
          type: object
          nullable: true
          description: Action for the client to perform
          properties:
            type:
              type: string
              description: Action type (show_services, show_slots, hold_slot, confirm_booking)
            params:
              type: object
              description: Action parameters
        data:
          type: object
          nullable: true
          description: Data payload (services, slots, booking confirmation, etc.)
        chips:
          type: array
          items:
            type: string
          nullable: true
          description: Quick response options to show user
          example: ["1:00 PM", "2:30 PM", "4:00 PM"]
        shop_slug:
          type: string
          nullable: true
          description: Shop slug for context
        shop_name:
          type: string
          nullable: true
          description: Shop name for display

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            detail: "Invalid date format. Use YYYY-MM-DD."

    Unauthorized:
      description: Unauthorized - invalid or missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            detail: "Invalid API key"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            detail: "Service not found. Please check the service ID."

    Conflict:
      description: Conflict - slot not available
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            detail: "This time slot is already booked. Please choose a different time."
